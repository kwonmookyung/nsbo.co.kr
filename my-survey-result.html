<!DOCTYPE HTML>
<html>

<head>
    <title>무료견적 | 착한소상공인지원마켓</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <style>
        @media screen and (max-width: 1024px) {
            #header {
                display: none !important;
            }

            #mobile-logo {
                display: block !important;
                position: fixed;
                top: 1em;
                left: 1em;
                font-size: 1.2em;
                font-weight: bold;
                color: #000 !important;
                background: white;
                padding: 0.3em 0.6em;
                border-radius: 4px;
                z-index: 2000;
                text-decoration: none;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            }
        }

        @media screen and (max-width: 1024px) {

            /* 혹시 다른 위치에서 logo.jpg가 불려오는 것까지 제거 */
            img[src*="logo.jpg"] {
                display: none !important;
            }

            .wrapper.style1 {
                margin-top: 10px !important;
                /* 필요시 더 줄여도 됩니다 */
            }
        }
    </style>
</head>

<body class="is-preload">
    <div id="page-wrapper">

        <!-- Header -->
        <div id="header"
            style="position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 2em; background-color: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
            <div>
                <a href="index.html" id="logo">
                    <img src="images/logo.jpg" alt="착한소상공인지원마켓 로고" style="height: 80px;">
                </a>
            </div>

            <nav id="nav">
                <ul>
                    <li><a href="kakao-login.html" style="font-size: 0.85em;">로그인</a></li>
                    <li><a href="mypage.html" style="font-size: 0.85em;">마이페이지</a>
                        <ul>
                            <li><a href="mypage.html">내 정보 보기</a></li>
                            <li class="current"><a href="my-survey-result.html">내 설문조사 결과 보기</a></li>
                        </ul>
                    </li>
                    <li><a href="index.html">홈</a></li>
                    <li>
                        <a href="brand.html">브랜드</a>
                        <ul>
                            <li><a href="brand.html#company-intro">회사소개</a></li>
                            <li><a href="brand.html#ci">회사CI</a></li>
                            <li><a href="brand.html#culture">기업문화</a></li>
                            <li><a href="brand.html#sustainability">지속가능경영</a></li>
                            <li><a href="brand.html#roadmap">로드맵</a></li>
                        </ul>
                    </li>
                    //<li><a href="left-sidebar.html">솔루션</a></li>
                    //<li><a href="right-sidebar.html">프로그램</a></li>
                    <li><a href="two-sidebar.html">고객문의</a></li>
                    <li><a href="no-sidebar.html">무료견적</a></li>
                </ul>
            </nav>
        </div>

        <!-- Main -->
        <section class="wrapper style1" style="margin-top: 100px;">
            <div class="container">
                <header class="major">
                    <h2>내 설문조사 결과 보기</h2>
                    <p class="hint">
                        현재 UUID: <span id="currentUuid" class="mono">—</span>
                        <span id="status" style="margin-left:.4rem;"></span>
                    </p>
                    <div class="toolbar" style="margin-top:.6rem;">
                        <input id="uuidInput" class="mono" type="text" placeholder="수동으로 UUID 입력"
                            style="padding:.45rem .6rem; border:1px solid #ddd; border-radius:8px; min-width:260px;">
                        <button class="btn-sm" onclick="reloadWithUuid()">이 UUID로 보기</button>
                        <button class="btn-sm primary" onclick="goSurvey()">다시 설문하기</button>
                    </div>
                </header>

                <div id="loadingMsg" class="hint">결과 페이지를 불러오는 중입니다…</div>
                <div id="emptyMsg" class="hint" style="display:none;">
                    불러올 설문 결과가 없습니다. 먼저 설문을 완료해 주세요.
                </div>

                <div class="frame-wrap">
                    <iframe id="resultFrame" title="설문 결과"></iframe>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer id="footer">
            <div class="container">
                <section>
                    <h3>착한소상공인지원마켓 정보</h3>
                    <p>
                        상호명: 만두<br>
                        대표자: 권무경<br>
                        사업자등록번호: 853-41-01293<br>
                        통신판매업신고번호: 2025-서울동대문-1455호<br>
                        주소: 서울특별시 동대문구 장한로14길 81, 101동 3층 303호<br>
                        이메일: kmook1112@gmail.com<br>
                        고객센터: 010-3310-2885 (평일 10:00 ~ 17:00)
                    </p>
                </section>
                <ul class="copyright">
                    <li>&copy; 착한소상공인지원마켓. All rights reserved.</li>
                    <li>Powered by <a href="https://html5up.net" target="_blank">HTML5 UP</a></li>
                </ul>
            </div>
        </footer>

    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.dropotron.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script type="module">
        // ==== 배포 경로가 도메인 루트가 아닐 때만 설정 (예: '/nbso') ====
        const SITE_BASE = window.__SITE_BASE_PATH || ""; // 필요시 window.__SITE_BASE_PATH = '/nbso';

        // ==== 결과 페이지(서브폴더) 경로 ====
        const RESULT_PATH = "owner-survey/survey-result.html";

        // 헤더의 "내 설문조사 결과 보기" 링크들 모두 가져오기
        const links = Array.from(document.querySelectorAll('a.js-myresult-link'));
        if (!links.length) { /* 메뉴가 없는 페이지는 무시 */ }

        // 링크 href를 일괄 반영
        function setLinksHref(uuid) {
            for (const a of links) {
                const dest = new URL(`${SITE_BASE}/${RESULT_PATH}`, `${location.origin}/`);
                if (uuid) dest.searchParams.set("uuid", uuid);
                // 절대경로(href)로 넣되, 같은 도메인 내에서만 사용
                a.href = dest.pathname + dest.search;
            }
        }

        // uuid 우선순위: ① URL ?uuid ② localStorage ③ Firestore 최신 1건
        async function resolveUUID() {
            // ① URL 파라미터
            const u1 = new URLSearchParams(location.search).get("uuid");
            if (u1) return u1;

            // ② localStorage
            const u2 = localStorage.getItem("surveyUUID");
            if (u2) return u2;

            // ③ Firestore 조회(로그인된 경우)
            try {
                const [{ initializeApp }, { getAuth, onAuthStateChanged }, { getFirestore, collection, query, orderBy, limit, getDocs }] =
                    await Promise.all([
                        import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"),
                        import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"),
                        import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"),
                    ]);

                // 사이트 공용 Firebase 설정 그대로 사용
                const firebaseConfig = {
                    apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
                    authDomain: "nbso-b7f41.firebaseapp.com",
                    projectId: "nbso-b7f41",
                    storageBucket: "nbso-b7f41.appspot.com",
                    messagingSenderId: "94203359555",
                    appId: "1:94203359555:web:07f9ee21d1291670363ff6",
                    measurementId: "G-YCWF8ENKC4"
                };

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);

                // onAuthStateChanged를 Promise 형태로 대기
                const user = await new Promise((resolve) => {
                    onAuthStateChanged(auth, (u) => resolve(u), { onlyOnce: true });
                });
                if (!user) return null;

                const db = getFirestore(app);
                const q = query(
                    collection(db, `users/${user.uid}/survey_results`),
                    orderBy("createdAt", "desc"),
                    limit(1)
                );
                const snap = await getDocs(q);
                if (snap.empty) return null;

                const latestUUID = snap.docs[0].id;
                localStorage.setItem("surveyUUID", latestUUID);
                return latestUUID;
            } catch (e) {
                console.warn("uuid 조회 실패(무시):", e);
                return null;
            }
        }

        // 링크 클릭 시, uuid 없으면 마이페이지로 유도
        function attachFallbackClick() {
            for (const a of links) {
                a.addEventListener("click", (e) => {
                    // 이미 uuid 붙었으면 그대로 통과
                    if (a.href.includes("uuid=")) return;

                    e.preventDefault();
                    // 로그인/연동/설문 안내하기 좋은 곳으로 이동
                    const my = new URL(`${SITE_BASE}/mypage.html`, `${location.origin}/`);
                    // 돌아올 때 uuid 붙여줄 수 있도록 현재 페이지도 전달 가능(옵션)
                    my.searchParams.set("from", location.pathname + location.search);
                    location.href = my.pathname + my.search;
                });
            }
        }

        // 실행
        (async () => {
            attachFallbackClick();                // 먼저 클릭 대안 연결
            const uuid = await resolveUUID();     // uuid 확보 시도
            setLinksHref(uuid);                   // 확보되면 링크에 반영
        })();
    </script>
</body>

</html>