<!DOCTYPE HTML>
<html>

<head>
  <title>착소마켓 | 착한소상공인지원마켓</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    /* ===== 기존 반응형 헤더 동작 유지 ===== */
    @media screen and (max-width: 1024px) {
      #header {
        display: none !important;
      }

      #mobile-logo {
        display: block !important;
        position: fixed;
        top: 1em;
        left: 1em;
        font-size: 1.2em;
        font-weight: bold;
        color: #000 !important;
        background: white;
        padding: 0.3em 0.6em;
        border-radius: 4px;
        z-index: 2000;
        text-decoration: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
    }

    @media screen and (max-width: 1024px) {
      img[src*="logo.jpg"] {
        display: none !important;
      }

      .wrapper.style1 {
        margin-top: 10px !important;
      }
    }

    /* ===== 견적 폼 전용 스타일(콘텐츠만 추가) ===== */
    .quote-card {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
      padding: 1.75rem;
    }

    .quote-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 980px) {
      .quote-grid {
        grid-template-columns: 1fr;
      }
    }

    .field label {
      display: block;
      font-weight: 700;
      margin: 0 0 .4rem;
    }

    .select {
      position: relative;
    }

    .helper {
      color: #666;
      font-size: .95rem;
      margin-top: .25rem;
    }

    .result-box {
      margin-top: 1.25rem;
      background: #f7f8fb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      line-height: 1.6;
    }

    .price {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .muted {
      color: #6b7280;
    }

    .actions {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .actions .button.secondary {
      background: #eef2ff;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .status {
      margin-top: .5rem;
      color: #ef4444;
      font-weight: 600;
      display: none;
    }

    /* ===== 문의 섹션 추가 스타일 ===== */
    .quote-inquiry {
      margin-top: 1.25rem;
      display: none;
    }

    .quote-inquiry .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .quote-inquiry .grid .full {
      grid-column: 1 / -1;
    }

    @media (max-width:980px) {
      .quote-inquiry .grid {
        grid-template-columns: 1fr;
      }
    }

    .quote-inquiry .field input,
    .quote-inquiry .field textarea,
    .quote-inquiry .field select {
      width: 100%;
    }

    .toast {
      margin-top: .75rem;
      padding: .6rem .8rem;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      display: none;
    }

    .toast.ok {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #166534;
    }

    .toast.err {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b;
    }
  </style>
</head>

<body class="is-preload">
  <div id="page-wrapper">

    <div id="header"
      style="position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 2em; background-color: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <div>
        <a href="index.html" id="logo">
          <img src="images/logo.jpg" alt="착한소상공인지원마켓 로고" style="height: 80px;">
        </a>
      </div>

      <nav id="nav">
        <ul>
          <li><a href="kakao-login.html" style="font-size: 0.85em;">로그인</a></li>
          <li><a href="mypage.html" style="font-size: 0.85em;">마이페이지</a>
            <ul>
              <li><a href="mypage.html">내 정보 보기</a></li>
              <li><a class="js-myresult-link" href="owner-survey/survey-result.html">내 설문조사 결과 보기</a></li>
            </ul>
          </li>
          <li><a href="index.html">홈</a></li>
          <li>
            <a href="brand.html">브랜드</a>
            <ul>
              <li><a href="brand.html#company-intro">회사소개</a></li>
              <li><a href="brand.html#ci">회사CI</a></li>
              <li><a href="brand.html#culture">기업문화</a></li>
              <li><a href="brand.html#sustainability">지속가능경영</a></li>
              <li><a href="brand.html#roadmap">로드맵</a></li>
            </ul>
          </li>
          <li><a href="left-sidebar.html">솔루션</a></li>
          <li><a href="right-sidebar.html">프로그램</a></li>
          <li><a href="two-sidebar.html">고객문의</a></li>
          <li class="current"><a href="no-sidebar.html">착소마켓</a></li>
        </ul>
      </nav>
    </div>

    <section class="wrapper style1" style="margin-top: 100px;">
      <div class="container">
        <header class="major">
          <h2>무료 견적 받기</h2>
          <p class="muted">대분류 → 중분류 → 소분류를 선택하면, 즉시 예상 견적을 계산해 드립니다.</p>
        </header>

        <div class="quote-card" role="form" aria-labelledby="quote-title">
          <h3 id="quote-title" style="margin-top:0">분류를 선택해 주세요</h3>

          <div class="quote-grid">
            <div class="field">
              <label for="catA">대분류</label>
              <div class="select">
                <select id="catA" aria-label="대분류 선택">
                  <option value="" selected disabled>선택하세요 (A ~ G)</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="G">G</option>
                </select>
              </div>
              <p class="helper">대분류를 선택하면 중분류가 활성화됩니다.</p>
            </div>

            <div class="field">
              <label for="catB">중분류</label>
              <div class="select">
                <select id="catB" aria-label="중분류 선택" disabled>
                  <option value="" selected disabled>대분류를 먼저 선택하세요</option>
                </select>
              </div>
              <p class="helper">예: A 선택 시 A-1 ~ A-5</p>
            </div>

            <div class="field">
              <label for="catC">소분류</label>
              <div class="select">
                <select id="catC" aria-label="소분류 선택" disabled>
                  <option value="" selected disabled>중분류를 먼저 선택하세요</option>
                </select>
              </div>
              <p class="helper">예: A-1 선택 시 A-1-1 ~ A-1-5</p>
            </div>
          </div>

          <div class="actions">
            <a id="btn-quote" class="button primary">무료 견적 받기</a>
            <a id="btn-reset" class="button secondary">초기화</a>
          </div>
          <div id="status" class="status">필수 항목을 모두 선택해 주세요.</div>

          <div id="result" class="result-box" style="display:none">
            <div class="muted">선택 경로</div>
            <div id="selectedPath" style="font-weight:700; margin:.25rem 0 .75rem"></div>
            <div class="muted">예상 견적</div>
            <div class="price" id="price">-</div>
            <div class="muted" style="margin-top:.5rem">* 안내 금액은 기본 옵션 기준의 예상가입니다. 실제 상황에 따라 변동될 수 있습니다.</div>
          </div>

          <div id="inquirySection" class="quote-inquiry" aria-labelledby="inq-title">
            <h3 id="inq-title" style="margin:1rem 0 .5rem">상담/문의 정보 입력</h3>
            <p class="muted" style="margin-top:0">견적 확인 후, 연락받을 정보를 남겨주세요. 저장 시 관리자에게 접수됩니다.</p>
            <div class="grid">
              <div class="field">
                <label for="inqName">이름</label>
                <input type="text" id="inqName" placeholder="홍길동" autocomplete="name" />
              </div>
              <div class="field">
                <label for="inqPhone">전화번호<span style="color:red">*</span></label>
                <input type="tel" id="inqPhone" placeholder="010-0000-0000" autocomplete="tel" />
              </div>
              <div class="field full">
                <label for="inqAddress">주소</label>
                <input type="text" id="inqAddress" placeholder="도로명 주소" autocomplete="street-address" />
              </div>
              <div class="field">
                <label for="inqEmail">이메일</label>
                <input type="email" id="inqEmail" placeholder="you@example.com" autocomplete="email" />
              </div>
              <div class="field">
                <label for="inqTime">상담 희망 시간</label>
                <select id="inqTime">
                  <option value="" selected disabled>선택하세요</option>
                  <option>평일 오전 (09~12)</option>
                  <option>평일 오후 (13~17)</option>
                  <option>저녁/주말 (협의)</option>
                </select>
              </div>
              <div class="field full">
                <label for="inqMemo">기타 특이 사항</label>
                <textarea id="inqMemo" rows="4" placeholder="현장 특이사항, 요청사항 등을 적어주세요"></textarea>
              </div>
            </div>
            <div class="actions">
              <a id="btn-send-inquiry" class="button primary">문의하기</a>
              <a id="btn-clear-inquiry" class="button secondary">입력 지우기</a>
            </div>
            <div id="inquiryToast" class="toast" role="status" aria-live="polite"></div>
          </div>

        </div>
      </div>
    </section>

    <footer id="footer">
      <div class="container">
        <section>
          <h3>착한소상공인지원마켓 정보</h3>
          <p>
            상호명: 만두<br>
            대표자: 권무경<br>
            사업자등록번호: 853-41-01293<br>
            통신판매업신고번호: 2025-서울동대문-1455호<br>
            주소: 서울특별시 동대문구 장한로14길 81, 101동 3층 303호<br>
            이메일: kmook1112@gmail.com<br>
            고객센터: 010-3310-2885 (평일 10:00 ~ 17:00)
          </p>
        </section>
        <ul class="copyright">
          <li>&copy; 착한소상공인지원마켓. All rights reserved.</li>
          <li>Powered by <a href="https://html5up.net" target="_blank">HTML5 UP</a></li>
        </ul>
      </div>
    </footer>

  </div>

  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/jquery.dropotron.min.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>

  <script type="module">
    // Firebase 모듈 로드
    import {
      initializeApp,
      getApps
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Firebase 설정
    const firebaseConfig = {
      apiKey: 'AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4',
      authDomain: 'nbso-b7f41.firebaseapp.com',
      projectId: 'nbso-b7f41',
      storageBucket: 'nbso-b7f41.appspot.com',
      messagingSenderId: '94203359555',
      appId: '1:94203359555:web:07f9ee21d1291670363ff6',
      measurementId: 'G-YCWF8ENKC4'
    };
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ====== 모든 요소 참조를 한 곳에서 선언 ======
    const catA = document.getElementById('catA');
    const catB = document.getElementById('catB');
    const catC = document.getElementById('catC');

    const btnQuote = document.getElementById('btn-quote');
    const btnReset = document.getElementById('btn-reset');

    const boxResult = document.getElementById('result');
    const elPath = document.getElementById('selectedPath');
    const elPrice = document.getElementById('price');
    const elStatus = document.getElementById('status');

    // 문의 섹션 요소
    const inquirySection = document.getElementById('inquirySection');
    const inqName = document.getElementById('inqName');
    const inqPhone = document.getElementById('inqPhone');
    const inqAddress = document.getElementById('inqAddress');
    const inqEmail = document.getElementById('inqEmail');
    const inqTime = document.getElementById('inqTime');
    const inqMemo = document.getElementById('inqMemo');
    const btnSendInquiry = document.getElementById('btn-send-inquiry');
    const btnClearInquiry = document.getElementById('btn-clear-inquiry');
    const inquiryToast = document.getElementById('inquiryToast');

    // ====== 공통 유틸 ======
    const fmtKRW = (n) => n.toLocaleString('ko-KR') + '원';

    // ====== 중/소분류 옵션 생성 ======
    function setOptions(select, values, placeholder) {
      select.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = placeholder;
      opt0.disabled = true;
      opt0.selected = true;
      select.appendChild(opt0);
      values.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
      });
    }

    function range(n) {
      return Array.from({
        length: n
      }, (_, i) => i + 1);
    }

    // ====== 가격 계산 로직 ======
    function calcPrice(a, b, c) {
      const idxA = a.charCodeAt(0) - 'A'.charCodeAt(0);
      const mid = Number(b.split('-')[1]);
      const sub = Number(c.split('-')[2]);
      const n = idxA * 25 + (mid - 1) * 5 + (sub - 1) + 1;
      return n * 1000;
    }

    // ====== 이벤트 리스너: 견적 계산 및 UI 제어 ======
    catA.addEventListener('change', () => {
      const a = catA.value;
      if (!a) return;
      const mids = range(5).map(i => `${a}-${i}`);
      setOptions(catB, mids, '중분류 선택');
      catB.disabled = false;
      setOptions(catC, [], '중분류를 먼저 선택하세요');
      catC.disabled = true;
      boxResult.style.display = 'none';
      elStatus.style.display = 'none';
      inquirySection.style.display = 'none'; // 견적 재선택 시 문의 섹션 숨기기
    });

    catB.addEventListener('change', () => {
      const b = catB.value;
      if (!b) return;
      const subs = range(5).map(i => `${b}-${i}`);
      setOptions(catC, subs, '소분류 선택');
      catC.disabled = false;
      boxResult.style.display = 'none';
      elStatus.style.display = 'none';
      inquirySection.style.display = 'none'; // 견적 재선택 시 문의 섹션 숨기기
    });

    btnQuote.addEventListener('click', () => {
      const a = catA.value,
        b = catB.value,
        c = catC.value;
      if (!a || !b || !c) {
        elStatus.style.display = 'block';
        boxResult.style.display = 'none';
        inquirySection.style.display = 'none';
        return;
      }
      elStatus.style.display = 'none';
      const price = calcPrice(a, b, c);
      elPath.textContent = `${c}`;
      elPrice.textContent = fmtKRW(price);
      boxResult.style.display = 'block';
      inquirySection.style.display = 'block';
      inquiryToast.style.display = 'none';
      inquiryToast.textContent = '';
      inquiryToast.className = 'toast';
    });

    btnReset.addEventListener('click', () => {
      catA.value = '';
      setOptions(catB, [], '대분류를 먼저 선택하세요');
      catB.disabled = true;
      setOptions(catC, [], '중분류를 먼저 선택하세요');
      catC.disabled = true;
      boxResult.style.display = 'none';
      elStatus.style.display = 'none';
      inquirySection.style.display = 'none';

      // 문의 폼 초기화
      [inqName, inqPhone, inqAddress, inqEmail].forEach(i => i.value = '');
      inqTime.value = '';
      inqMemo.value = '';
      inquiryToast.style.display = 'none';
    });

    // 입력 지우기(문의 섹션만)
    btnClearInquiry.addEventListener('click', () => {
      [inqName, inqPhone, inqAddress, inqEmail].forEach(i => i.value = '');
      inqTime.value = '';
      inqMemo.value = '';
      inquiryToast.style.display = 'none';
      inquiryToast.textContent = '';
      inquiryToast.className = 'toast';
    });

    // ====== 문의 저장: 유효성 검사, 로딩 상태, 자동 초기화 포함 ======
    btnSendInquiry.addEventListener('click', async () => {
      const a = catA.value,
        b = catB.value,
        c = catC.value;
      const name = inqName.value.trim();
      const phone = inqPhone.value.trim();
      const email = inqEmail.value.trim();

      const phoneRegex = /^\d{2,3}-\d{3,4}-\d{4}$/;
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;

      if (!name || !phone) {
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = '이름과 전화번호는 필수 입력 항목입니다.';
        inquiryToast.style.display = 'block';
        return;
      }

      if (!phoneRegex.test(phone)) {
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = "유효한 전화번호 형식이 아닙니다 (예: 010-1234-5678)";
        inquiryToast.style.display = 'block';
        return;
      }

      if (email && !emailRegex.test(email)) {
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = "유효한 이메일 형식이 아닙니다 (예: example@domain.com)";
        inquiryToast.style.display = 'block';
        return;
      }

      btnSendInquiry.textContent = '전송 중...';
      btnSendInquiry.disabled = true;
      inquiryToast.style.display = 'none';

      try {
        const doc = {
          categoryTop: a,
          categoryMid: b,
          categorySub: c,
          price: calcPrice(a, b, c),
          name: name,
          phone: phone,
          address: inqAddress.value.trim(),
          email: email,
          preferredTime: inqTime.value || null,
          memo: inqMemo.value.trim() || null,
          createdAt: serverTimestamp(),
          sourcePage: location.pathname + location.search
        };
        await addDoc(collection(db, 'inquiries'), doc);
        inquiryToast.className = 'toast ok';
        inquiryToast.textContent = '접수되었습니다. 빠르게 확인 후 연락드리겠습니다.';
        inquiryToast.style.display = 'block';

        // 성공 시 폼 초기화
        [inqName, inqPhone, inqAddress, inqEmail, inqMemo].forEach(i => i.value = '');
        inqTime.value = '';

      } catch (e) {
        console.error(e);
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = '저장 중 문제가 발생했습니다. 잠시 후 다시 시도해 주세요.';
        inquiryToast.style.display = 'block';
      } finally {
        btnSendInquiry.textContent = '문의하기';
        btnSendInquiry.disabled = false;
      }
    });

    // ====== 설문 결과 링크용 UUID 처리 (기존 코드) ======
    const SITE_BASE = window.__SITE_BASE_PATH || "";
    const RESULT_PATH = "owner-survey/survey-result.html";
    const links = Array.from(document.querySelectorAll('a.js-myresult-link'));

    function setLinksHref(uuid) {
      for (const a of links) {
        const dest = new URL(`${SITE_BASE}/${RESULT_PATH}`, `${location.origin}/`);
        if (uuid) dest.searchParams.set("uuid", uuid);
        a.href = dest.pathname + dest.search;
      }
    }

    async function resolveUUID() {
      const u1 = new URLSearchParams(location.search).get("uuid");
      if (u1) return u1;
      const u2 = localStorage.getItem("surveyUUID");
      if (u2) return u2;
      try {
        const [{
          initializeApp
        }, {
          getAuth,
          onAuthStateChanged
        }, {
          getFirestore,
          collection,
          query,
          orderBy,
          limit,
          getDocs
        }] =
          await Promise.all([
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"),
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"),
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"),
          ]);
        const firebaseConfig = {
          apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
          authDomain: "nbso-b7f41.firebaseapp.com",
          projectId: "nbso-b7f41",
          storageBucket: "nbso-b7f41.appspot.com",
          messagingSenderId: "94203359555",
          appId: "1:94203359555:web:07f9ee21d1291670363ff6",
          measurementId: "G-YCWF8ENKC4"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const user = await new Promise((resolve) => {
          onAuthStateChanged(auth, (u) => resolve(u));
        });
        if (!user) return null;
        const db = getFirestore(app);
        const q = query(collection(db, `users/${user.uid}/survey_results`), orderBy("createdAt", "desc"), limit(1));
        const snap = await getDocs(q);
        if (snap.empty) return null;
        const latestUUID = snap.docs[0].id;
        localStorage.setItem("surveyUUID", latestUUID);
        return latestUUID;
      } catch (e) {
        console.warn("uuid 조회 실패(무시):", e);
        return null;
      }
    }

    function attachFallbackClick() {
      for (const a of links) {
        a.addEventListener("click", (e) => {
          if (a.href.includes("uuid=")) return;
          e.preventDefault();
          const my = new URL(`${SITE_BASE}/mypage.html`, `${location.origin}/`);
          my.searchParams.set("from", location.pathname + location.search);
          location.href = my.pathname + my.search;
        });
      }
    }
    (async () => {
      attachFallbackClick();
      const uuid = await resolveUUID();
      setLinksHref(uuid);
    })();
  </script>
</body>

</html>