<!DOCTYPE HTML>
<html>

<head>
  <title>착소마켓 | 착한소상공인지원마켓</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    /* ===== 기존 반응형 헤더 동작 유지 ===== */
    @media screen and (max-width: 1024px) {
      #header {
        display: none !important;
      }

      #mobile-logo {
        display: block !important;
        position: fixed;
        top: 1em;
        left: 1em;
        font-size: 1.2em;
        font-weight: bold;
        color: #000 !important;
        background: white;
        padding: 0.3em 0.6em;
        border-radius: 4px;
        z-index: 2000;
        text-decoration: none;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
    }

    @media screen and (max-width: 1024px) {
      img[src*="logo.jpg"] {
        display: none !important;
      }

      .wrapper.style1 {
        margin-top: 10px !important;
      }
    }

    /* ===== 견적 폼 전용 스타일(콘텐츠만 추가) ===== */
    .quote-card {
      max-width: 820px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
      padding: 1.75rem;
    }

    .quote-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
      /* 5단계에 맞춰 확장 */
      gap: 1rem;
    }

    @media (max-width: 980px) {
      .quote-grid {
        grid-template-columns: 1fr;
      }
    }

    .field label {
      display: block;
      font-weight: 700;
      margin: 0 0 .4rem;
    }

    .select {
      position: relative;
    }

    .helper {
      color: #666;
      font-size: .95rem;
      margin-top: .25rem;
    }

    .result-box {
      margin-top: 1.25rem;
      background: #f7f8fb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      line-height: 1.6;
    }

    .price {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .muted {
      color: #6b7280;
    }

    .actions {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }

    .actions .button.secondary {
      background: #eef2ff;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .status {
      margin-top: .5rem;
      color: #ef4444;
      font-weight: 600;
      display: none;
    }

    /* ===== 문의 섹션 추가 스타일 ===== */
    .quote-inquiry {
      margin-top: 1.25rem;
      display: none;
    }

    .quote-inquiry .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .quote-inquiry .grid .full {
      grid-column: 1 / -1;
    }

    @media (max-width:980px) {
      .quote-inquiry .grid {
        grid-template-columns: 1fr;
      }
    }

    .quote-inquiry .field input,
    .quote-inquiry .field textarea,
    .quote-inquiry .field select {
      width: 100%;
    }

    .toast {
      margin-top: .75rem;
      padding: .6rem .8rem;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      display: none;
    }

    .toast.ok {
      background: #f0fdf4;
      border-color: #bbf7d0;
      color: #166534;
    }

    .toast.err {
      background: #fef2f2;
      border-color: #fecaca;
      color: #991b1b;
    }
  </style>
</head>

<body class="is-preload">
  <div id="page-wrapper">

    <div id="header"
      style="position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 2em; background-color: white; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
      <div>
        <a href="index.html" id="logo">
          <img src="images/logo.jpg" alt="착한소상공인지원마켓 로고" style="height: 80px;">
        </a>
      </div>

      <nav id="nav">
        <ul>
          <li><a href="kakao-login.html" style="font-size: 0.85em;">로그인</a></li>
          <li><a href="mypage.html" style="font-size: 0.85em;">마이페이지</a>
            <ul>
              <li><a href="mypage.html">내 정보 보기</a></li>
              <li><a class="js-myresult-link" href="owner-survey/survey-result.html">내 설문조사 결과 보기</a></li>
            </ul>
          </li>
          <li><a href="index.html">홈</a></li>
          <li>
            <a href="brand.html">브랜드</a>
            <ul>
              <li><a href="brand.html#company-intro">회사소개</a></li>
              <li><a href="brand.html#ci">회사CI</a></li>
              <li><a href="brand.html#culture">기업문화</a></li>
              <li><a href="brand.html#sustainability">지속가능경영</a></li>
              <li><a href="brand.html#roadmap">로드맵</a></li>
            </ul>
          </li>
          <li><a href="left-sidebar.html">솔루션</a></li>
          <li><a href="right-sidebar.html">프로그램</a></li>
          <li><a href="two-sidebar.html">고객문의</a></li>
          <li class="current"><a href="no-sidebar.html">착소마켓</a></li>
        </ul>
      </nav>
    </div>

    <section class="wrapper style1" style="margin-top: 100px;">
      <div class="container">
        <header class="major">
          <h2>무료 견적 받기</h2>
          <p class="muted">1단계 → 2단계 → 3단계 → 4단계 → 5단계를 선택하면, 즉시 예상 견적을 보여드립니다.</p>
        </header>

        <div class="quote-card" role="form" aria-labelledby="quote-title">
          <h3 id="quote-title" style="margin-top:0">분류를 선택해 주세요</h3>

          <!-- ▼▼ 기존 3단계 셀렉트 → 5단계 셀렉트로 교체 ▼▼ -->
          <div class="quote-grid">
            <div class="field">
              <label for="cat1">1단계 (대분류)</label>
              <div class="select">
                <select id="cat1" aria-label="1단계 선택">
                  <option value="" selected disabled>선택하세요 (A~E)</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                </select>
              </div>
              <p class="helper">1단계를 선택하면 2단계가 활성화됩니다.</p>
            </div>

            <div class="field">
              <label for="cat2">2단계</label>
              <div class="select">
                <select id="cat2" aria-label="2단계 선택" disabled>
                  <option value="" selected disabled>1단계를 먼저 선택하세요</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="cat3">3단계</label>
              <div class="select">
                <select id="cat3" aria-label="3단계 선택" disabled>
                  <option value="" selected disabled>2단계를 먼저 선택하세요</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="cat4">4단계</label>
              <div class="select">
                <select id="cat4" aria-label="4단계 선택" disabled>
                  <option value="" selected disabled>3단계를 먼저 선택하세요</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="cat5">5단계</label>
              <div class="select">
                <select id="cat5" aria-label="5단계 선택" disabled>
                  <option value="" selected disabled>4단계를 먼저 선택하세요</option>
                </select>
              </div>
              <p class="helper">마지막 단계(리프)를 선택하면 가격이 표시됩니다.</p>
            </div>
          </div>
          <!-- ▲▲ 여기까지 5단계 UI ▲▲ -->

          <div class="actions">
            <a id="btn-quote" class="button primary">무료 견적 받기</a>
            <a id="btn-reset" class="button secondary">초기화</a>
          </div>
          <div id="status" class="status">필수 항목을 모두 선택해 주세요.</div>

          <div id="result" class="result-box" style="display:none">
            <div class="muted">선택 경로</div>
            <div id="selectedPath" style="font-weight:700; margin:.25rem 0 .75rem"></div>
            <div class="muted">예상 견적</div>
            <div class="price" id="price">-</div>
            <div class="muted" style="margin-top:.5rem">* 안내 금액은 기본 옵션 기준의 예상가입니다. 실제 상황에 따라 변동될 수 있습니다.</div>
          </div>

          <div id="inquirySection" class="quote-inquiry" aria-labelledby="inq-title">
            <h3 id="inq-title" style="margin:1rem 0 .5rem">상담/문의 정보 입력</h3>
            <p class="muted" style="margin-top:0">견적 확인 후, 연락받을 정보를 남겨주세요. 저장 시 관리자에게 접수됩니다.</p>
            <div class="grid">
              <div class="field">
                <label for="inqName">이름</label>
                <input type="text" id="inqName" placeholder="홍길동" autocomplete="name" />
              </div>
              <div class="field">
                <label for="inqPhone">전화번호<span style="color:red">*</span></label>
                <input type="tel" id="inqPhone" placeholder="010-0000-0000" autocomplete="tel" />
              </div>
              <div class="field full">
                <label for="inqAddress">주소</label>
                <input type="text" id="inqAddress" placeholder="도로명 주소" autocomplete="street-address" />
              </div>
              <div class="field">
                <label for="inqEmail">이메일</label>
                <input type="email" id="inqEmail" placeholder="you@example.com" autocomplete="email" />
              </div>
              <div class="field">
                <label for="inqTime">상담 희망 시간</label>
                <select id="inqTime">
                  <option value="" selected disabled>선택하세요</option>
                  <option>평일 오전 (09~12)</option>
                  <option>평일 오후 (13~17)</option>
                  <option>저녁/주말 (협의)</option>
                </select>
              </div>
              <div class="field full">
                <label for="inqMemo">기타 특이 사항</label>
                <textarea id="inqMemo" rows="4" placeholder="현장 특이사항, 요청사항 등을 적어주세요"></textarea>
              </div>
            </div>
            <div class="actions">
              <a id="btn-send-inquiry" class="button primary">문의하기</a>
              <a id="btn-clear-inquiry" class="button secondary">입력 지우기</a>
            </div>
            <div id="inquiryToast" class="toast" role="status" aria-live="polite"></div>
          </div>

        </div>
      </div>
    </section>

    <footer id="footer">
      <div class="container">
        <section>
          <h3>착한소상공인지원마켓 정보</h3>
          <p>
            상호명: 만두<br>
            대표자: 권무경<br>
            사업자등록번호: 853-41-01293<br>
            통신판매업신고번호: 2025-서울동대문-1455호<br>
            주소: 서울특별시 동대문구 장한로14길 81, 101동 3층 303호<br>
            이메일: kmook1112@gmail.com<br>
            고객센터: 010-3310-2885 (평일 10:00 ~ 17:00)
          </p>
        </section>
        <ul class="copyright">
          <li>&copy; 착한소상공인지원마켓. All rights reserved.</li>
          <li>Powered by <a href="https://html5up.net" target="_blank">HTML5 UP</a></li>
        </ul>
      </div>
    </footer>

  </div>

  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/jquery.dropotron.min.js"></script>
  <script src="assets/js/browser.min.js"></script>
  <script src="assets/js/breakpoints.min.js"></script>
  <script src="assets/js/util.js"></script>
  <script src="assets/js/main.js"></script>

  <script type="module">
    // Firebase 모듈 로드
    import {
      initializeApp,
      getApps
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Firebase 설정
    const firebaseConfig = {
      apiKey: 'AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4',
      authDomain: 'nbso-b7f41.firebaseapp.com',
      projectId: 'nbso-b7f41',
      storageBucket: 'nbso-b7f41.appspot.com',
      messagingSenderId: '94203359555',
      appId: '1:94203359555:web:07f9ee21d1291670363ff6',
      measurementId: 'G-YCWF8ENKC4'
    };
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* =========================================================
       5단계 트리 선택: A~E JSON 로드 → 정규화 → 옵션 생성
       JSON 경로: /data/A_data.json ... /data/E_data.json
       가격은 JSON의 price / price_range 문자열을 그대로 사용
    ==========================================================*/

    // DOM 참조
    const $ = (id) => document.getElementById(id);
    const cat1 = $('cat1'), cat2 = $('cat2'), cat3 = $('cat3'), cat4 = $('cat4'), cat5 = $('cat5');

    const btnQuote = $('btn-quote');
    const btnReset = $('btn-reset');

    const boxResult = $('result');
    const elPath = $('selectedPath');
    const elPrice = $('price');
    const elStatus = $('status');

    // 문의 섹션 요소
    const inquirySection = $('inquirySection');
    const inqName = $('inqName');
    const inqPhone = $('inqPhone');
    const inqAddress = $('inqAddress');
    const inqEmail = $('inqEmail');
    const inqTime = $('inqTime');
    const inqMemo = $('inqMemo');
    const btnSendInquiry = $('btn-send-inquiry');
    const btnClearInquiry = $('btn-clear-inquiry');
    const inquiryToast = $('inquiryToast');

    // JSON 소스 매핑 (필요 시 경로만 교체)
    const DATA_SOURCES = {
      A: '/data/A_data.json',
      B: '/data/B_data.json',
      C: '/data/C_data.json',
      D: '/data/D_data.json',
      E: '/data/E_data.json',
    };

    // 공통 옵션 세팅
    const setOptions = (sel, items, placeholder) => {
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = placeholder;
      opt0.disabled = true; opt0.selected = true;
      sel.appendChild(opt0);
      for (const it of items) {
        const opt = document.createElement('option');
        opt.value = it.code || it.value || it.id;
        opt.textContent = it.name || it.label || it.content || it.code;
        if (it.price || it.price_range) {
          opt.dataset.price = it.price || it.price_range;
        }
        sel.appendChild(opt);
      }
    };

    // 다양한 스키마(A/B/C/D/E)를 공통 트리 {code,name,price?,children[]}로 정규화
    const node = (code, name, price, children = []) => ({ code, name, price, children });

    function normalizeA(raw, letter) {
      // 예시 스키마: {공간유형:{A:{name, services:{A-1:{name, cats1:{A-1-1:{name, price} ...}, cats2, cats3}}}}}
      const rootA = raw?.['공간유형']?.[letter];
      const root = node(letter, rootA?.name || letter);
      const services = rootA?.services || {};
      for (const [svcCode, svc] of Object.entries(services)) {
        const svcNode = node(svcCode, svc?.name || svcCode);
        const pushCats = (parent, cats) => {
          for (const [k, v] of Object.entries(cats || {})) {
            const n = node(k, v?.name || k, v?.price || v?.price_range || '');
            // 하위 cats*가 더 있으면 중간 노드로 처리
            if (v?.cats1 || v?.cats2 || v?.cats3) {
              n.price = '';
              if (v?.cats1) pushCats(n, v.cats1);
              if (v?.cats2) pushCats(n, v.cats2);
              if (v?.cats3) pushCats(n, v.cats3);
            }
            parent.children.push(n);
          }
        };
        if (svc?.cats1 || svc?.cats2 || svc?.cats3) {
          if (svc.cats1) pushCats(svcNode, svc.cats1);
          if (svc.cats2) pushCats(svcNode, svc.cats2);
          if (svc.cats3) pushCats(svcNode, svc.cats3);
        }
        root.children.push(svcNode);
      }
      return root;
    }

    function normalizeBLike(raw, letter) {
      // 예시 스키마: { [letter]: { content, subcategories:{ code:{ content,name, price/price_range, subcategories:{...}}}}}
      const top = raw?.[letter];
      const build = (code, obj) => {
        const nm = obj?.name || obj?.content || code;
        const price = obj?.price || obj?.price_range || '';
        const sc = obj?.subcategories;
        const n = node(code, nm, price);
        if (sc && typeof sc === 'object') {
          n.price = '';
          for (const [k, v] of Object.entries(sc)) n.children.push(build(k, v));
        }
        return n;
      };
      const root = node(letter, top?.content || top?.name || letter);
      const sc = top?.subcategories || {};
      for (const [k, v] of Object.entries(sc)) root.children.push(build(k, v));
      return root;
    }

    function normalizeE(raw) {
      // 예시 스키마: { code:'E', name:'...', children:[...] } (각 child 동일 형태)
      const build = (obj) => {
        const n = node(obj.code, obj.name, obj.price || obj.price_range || '');
        const ch = obj.children || [];
        if (ch.length) {
          n.price = '';
          for (const c of ch) n.children.push(build(c));
        }
        return n;
      };
      return build(raw);
    }

    function normalizeTree(letter, raw) {
      if (letter === 'A') return normalizeA(raw, letter);
      if (letter === 'B' || letter === 'C' || letter === 'D') return normalizeBLike(raw, letter);
      if (letter === 'E') return normalizeE(raw);
      return node(letter, letter);
    }

    // fetch + 캐시
    const cache = new Map();
    async function loadTopData(letter) {
      if (cache.has(letter)) return cache.get(letter);
      const url = DATA_SOURCES[letter];
      const res = await fetch(url);
      if (!res.ok) throw new Error(`데이터 로드 실패: ${url}`);
      const json = await res.json();
      const tree = normalizeTree(letter, json);
      cache.set(letter, tree);
      return tree;
    }

    // 경로에 따라 하위 children 조회
    function walk(tree, codes) {
      let cur = tree;
      if (!cur) return { cur: null, children: [] };
      for (const c of codes) {
        if (!c) break;
        const next = (cur.children || []).find(n => n.code === c);
        if (!next) return { cur, children: [] };
        cur = next;
      }
      return { cur, children: cur.children || [] };
    }

    // 하위 리셋
    function resetBelow(level /* 2..5 */) {
      const arr = [cat2, cat3, cat4, cat5];
      for (let i = level - 2; i < arr.length; i++) {
        if (i >= 0) {
          setOptions(arr[i], [], `${i + 2}단계를 먼저 선택하세요`);
          arr[i].disabled = true;
        }
      }
      boxResult.style.display = 'none';
      elStatus.style.display = 'none';
      inquirySection.style.display = 'none';
      inquiryToast.style.display = 'none';
    }

    // 트리 상태
    let currentTree = null;

    // 1단계
    cat1.addEventListener('change', async () => {
      try {
        resetBelow(2);
        const top = cat1.value; // 'A'..'E'
        if (!top) return;
        currentTree = await loadTopData(top);

        // 2단계 = root.children (top 노드 자체 포함돼 있을 수 있어 codes=[top]로 walk)
        const { children } = walk(currentTree, []);
        setOptions(cat2, children, '2단계 선택');
        cat2.disabled = false;
      } catch (e) {
        console.error(e);
        elStatus.textContent = '데이터 로드에 실패했습니다. 새로고침 후 다시 시도해 주세요.';
        elStatus.style.display = 'block';
      }
    });

    // 2단계
    cat2.addEventListener('change', () => {
      resetBelow(3);
      const top = cat1.value, s2 = cat2.value;
      if (!top || !s2 || !currentTree) return;
      const { children } = walk(currentTree, [s2]);
      if (children.length) {
        setOptions(cat3, children, '3단계 선택');
        cat3.disabled = false;
      } else {
        // 2단계가 리프
        const sel = cat2.selectedOptions[0];
        const priceStr = sel?.dataset?.price || '';
        elPath.textContent = [top, s2].join(' > ');
        elPrice.textContent = priceStr || '상담 필요(가격 정보 없음)';
        boxResult.style.display = 'block';
        inquirySection.style.display = 'block';
      }
    });

    // 3단계
    cat3.addEventListener('change', () => {
      resetBelow(4);
      const top = cat1.value, s2 = cat2.value, s3 = cat3.value;
      if (!top || !s2 || !s3 || !currentTree) return;
      const { children } = walk(currentTree, [s2, s3]);
      if (children.length) {
        setOptions(cat4, children, '4단계 선택');
        cat4.disabled = false;
      } else {
        // 3단계가 리프
        const sel = cat3.selectedOptions[0];
        const priceStr = sel?.dataset?.price || '';
        elPath.textContent = [top, s2, s3].join(' > ');
        elPrice.textContent = priceStr || '상담 필요(가격 정보 없음)';
        boxResult.style.display = 'block';
        inquirySection.style.display = 'block';
      }
    });

    // 4단계
    cat4.addEventListener('change', () => {
      resetBelow(5);
      const top = cat1.value, s2 = cat2.value, s3 = cat3.value, s4 = cat4.value;
      if (!top || !s2 || !s3 || !s4 || !currentTree) return;
      const { children } = walk(currentTree, [s2, s3, s4]);
      if (children.length) {
        setOptions(cat5, children, '5단계 선택');
        cat5.disabled = false;
      } else {
        // 4단계가 리프
        const sel = cat4.selectedOptions[0];
        const priceStr = sel?.dataset?.price || '';
        elPath.textContent = [top, s2, s3, s4].join(' > ');
        elPrice.textContent = priceStr || '상담 필요(가격 정보 없음)';
        boxResult.style.display = 'block';
        inquirySection.style.display = 'block';
      }
    });

    // 5단계
    cat5.addEventListener('change', () => {
      const top = cat1.value, s2 = cat2.value, s3 = cat3.value, s4 = cat4.value, s5 = cat5.value;
      if (!top || !s2 || !s3 || !s4 || !s5) return;
      const sel = cat5.selectedOptions[0];
      const priceStr = sel?.dataset?.price || '';
      elPath.textContent = [top, s2, s3, s4, s5].join(' > ');
      elPrice.textContent = priceStr || '상담 필요(가격 정보 없음)';
      boxResult.style.display = 'block';
      inquirySection.style.display = 'block';
    });

    // "무료 견적 받기" → 필수 선택 확인(리프 선택 시 이미 결과 노출됨)
    btnQuote.addEventListener('click', () => {
      const ok =
        !!cat1.value &&
        !!cat2.value &&
        !!cat3.value &&
        (!!cat4.value) &&
        (!!cat5.value || cat5.disabled); // 4단계 리프 케이스 허용
      if (!ok) {
        elStatus.textContent = '필수 단계를 모두 선택해 주세요.';
        elStatus.style.display = 'block';
        boxResult.style.display = 'none';
        inquirySection.style.display = 'none';
      } else {
        elStatus.style.display = 'none';
        // 결과는 각 change 핸들러에서 이미 노출됨
      }
    });

    // 초기화
    btnReset.addEventListener('click', () => {
      cat1.value = '';
      setOptions(cat2, [], '1단계를 먼저 선택하세요');
      setOptions(cat3, [], '2단계를 먼저 선택하세요');
      setOptions(cat4, [], '3단계를 먼저 선택하세요');
      setOptions(cat5, [], '4단계를 먼저 선택하세요');
      cat2.disabled = true; cat3.disabled = true; cat4.disabled = true; cat5.disabled = true;

      boxResult.style.display = 'none';
      elStatus.style.display = 'none';
      inquirySection.style.display = 'none';

      // 문의 폼 초기화
      [inqName, inqPhone, inqAddress, inqEmail, inqMemo].forEach(i => i.value = '');
      inqTime.value = '';
      inquiryToast.style.display = 'none';
      inquiryToast.textContent = '';
      inquiryToast.className = 'toast';
    });

    // ====== 문의 저장: 유효성 검사, 로딩 상태, 자동 초기화 포함 ======
    btnSendInquiry.addEventListener('click', async () => {
      const name = inqName.value.trim();
      const phone = inqPhone.value.trim();
      const email = inqEmail.value.trim();

      const phoneRegex = /^\d{2,3}-\d{3,4}-\d{4}$/;
      const emailRegex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

      if (!name || !phone) {
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = '이름과 전화번호는 필수 입력 항목입니다.';
        inquiryToast.style.display = 'block';
        return;
      }
      if (!phoneRegex.test(phone)) {
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = "유효한 전화번호 형식이 아닙니다 (예: 010-1234-5678)";
        inquiryToast.style.display = 'block';
        return;
      }
      if (email && !emailRegex.test(email)) {
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = "유효한 이메일 형식이 아닙니다 (예: example@domain.com)";
        inquiryToast.style.display = 'block';
        return;
      }

      // ▼ 단계별 선택값/라벨 추출 유틸
      const pick = (sel) =>
        (sel && !sel.disabled && sel.value)
          ? { code: sel.value, name: sel.selectedOptions[0].textContent.trim() }
          : null;

      const s1 = pick(cat1);
      const s2 = pick(cat2);
      const s3 = pick(cat3);
      const s4 = pick(cat4);
      const s5 = pick(cat5);

      const selectedList = [s1, s2, s3, s4, s5].filter(Boolean);
      const codePath = selectedList.map(x => x.code).join(' > ') || null;
      const namePath = selectedList.map(x => x.name).join(' > ') || null;

      btnSendInquiry.textContent = '전송 중...';
      btnSendInquiry.disabled = true;
      inquiryToast.style.display = 'none';

      try {
        const doc = {
          // 기존 코드(호환 유지)
          category1: s1?.code || null,
          category2: s2?.code || null,
          category3: s3?.code || null,
          category4: s4?.code || null,
          category5: s5?.code || null,
          categoryPath: codePath,

          // ✅ 추가: 텍스트(라벨) 저장
          category1Text: s1?.name || null,
          category2Text: s2?.name || null,
          category3Text: s3?.name || null,
          category4Text: s4?.name || null,
          category5Text: s5?.name || null,
          categoryNamePath: namePath,

          // (옵션) 구조화된 배열도 함께 저장하면 후처리 편해요
          // categories: selectedList,  // 주석 해제 시 [{code,name}, ...] 형태로 저장

          price: elPrice.textContent || null, // 화면 표시 가격 그대로
          name: name,
          phone: phone,
          address: inqAddress.value.trim() || null,
          email: email || null,
          preferredTime: inqTime.value || null,
          memo: inqMemo.value.trim() || null,
          createdAt: serverTimestamp(),
          sourcePage: location.pathname + location.search
        };

        await addDoc(collection(db, 'inquiries'), doc);

        inquiryToast.className = 'toast ok';
        inquiryToast.textContent = '접수되었습니다. 빠르게 확인 후 연락드리겠습니다.';
        inquiryToast.style.display = 'block';

        // 성공 시 폼 초기화
        [inqName, inqPhone, inqAddress, inqEmail, inqMemo].forEach(i => i.value = '');
        inqTime.value = '';

      } catch (e) {
        console.error(e);
        inquiryToast.className = 'toast err';
        inquiryToast.textContent = '저장 중 문제가 발생했습니다. 잠시 후 다시 시도해 주세요.';
        inquiryToast.style.display = 'block';
      } finally {
        btnSendInquiry.textContent = '문의하기';
        btnSendInquiry.disabled = false;
      }
    });

    /* ====== 설문 결과 링크용 UUID 처리 (기존 코드 유지) ====== */
    const SITE_BASE = window.__SITE_BASE_PATH || "";
    const RESULT_PATH = "owner-survey/survey-result.html";
    const links = Array.from(document.querySelectorAll('a.js-myresult-link'));

    function setLinksHref(uuid) {
      for (const a of links) {
        const dest = new URL(`${SITE_BASE}/${RESULT_PATH}`, `${location.origin}/`);
        if (uuid) dest.searchParams.set("uuid", uuid);
        a.href = dest.pathname + dest.search;
      }
    }

    async function resolveUUID() {
      const u1 = new URLSearchParams(location.search).get("uuid");
      if (u1) return u1;
      const u2 = localStorage.getItem("surveyUUID");
      if (u2) return u2;
      try {
        const [{ initializeApp }, { getAuth, onAuthStateChanged }, { getFirestore, collection, query, orderBy, limit, getDocs }] =
          await Promise.all([
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"),
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"),
            import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"),
          ]);
        const firebaseConfig = {
          apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
          authDomain: "nbso-b7f41.firebaseapp.com",
          projectId: "nbso-b7f41",
          storageBucket: "nbso-b7f41.appspot.com",
          messagingSenderId: "94203359555",
          appId: "1:94203359555:web:07f9ee21d1291670363ff6",
          measurementId: "G-YCWF8ENKC4"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const user = await new Promise((resolve) => {
          onAuthStateChanged(auth, (u) => resolve(u));
        });
        if (!user) return null;
        const db = getFirestore(app);
        const q = query(collection(db, `users/${user.uid}/survey_results`), orderBy("createdAt", "desc"), limit(1));
        const snap = await getDocs(q);
        if (snap.empty) return null;
        const latestUUID = snap.docs[0].id;
        localStorage.setItem("surveyUUID", latestUUID);
        return latestUUID;
      } catch (e) {
        console.warn("uuid 조회 실패(무시):", e);
        return null;
      }
    }

    function attachFallbackClick() {
      for (const a of links) {
        a.addEventListener("click", (e) => {
          if (a.href.includes("uuid=")) return;
          e.preventDefault();
          const my = new URL(`${SITE_BASE}/mypage.html`, `${location.origin}/`);
          my.searchParams.set("from", location.pathname + location.search);
          location.href = my.pathname + my.search;
        });
      }
    }
    (async () => {
      attachFallbackClick();
      const uuid = await resolveUUID();
      setLinksHref(uuid);
    })();
  </script>
</body>

</html>