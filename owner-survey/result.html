<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì„¤ë¬¸ ê²°ê³¼</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <div class="result-wrapper bg-white p-8 sm:p-12 rounded-xl shadow-lg w-full max-w-2xl">
    <div id="result-content" class="flex flex-col items-center">
      <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-4 text-center">
        ì‚¬ì¥ë‹˜ì˜ MOTI ì„¤ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
      </h2>
      <p class="text-gray-600 mb-8 text-center">
        ìì„¸í•œ ìœ í˜• ë¶„ì„ ë° ë§ì¶¤ ê²°ê³¼ëŠ” ì¹´ì¹´ì˜¤í†¡ ì±„ë„ì„ í†µí•´ ì „ì†¡ë©ë‹ˆë‹¤.
      </p>

      <!-- ë²„íŠ¼ ì„¹ì…˜ -->
      <div class="mt-8 flex flex-col sm:flex-row sm:space-x-4 w-full">
        <button id="kakao-btn" onclick="submitResult()"
          class="kakao-btn w-full flex items-center justify-center bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 mb-4 sm:mb-0">
          <img src="https://developers.kakao.com/assets/img/about/logos/kakaolink/kakaolink_btn_small.png" alt="ì¹´ì¹´ì˜¤ ì•„ì´ì½˜"
            class="h-5 mr-2" />
          ì¹´ì¹´ì˜¤ë¡œ ê²°ê³¼ ë°›ê¸°
        </button>
        <a href="survey.html"
          class="back-btn w-full flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-6 rounded-lg shadow-md transition-colors duration-300">
          ë‹¤ì‹œ í•˜ê¸°
        </a>
      </div>
    </div>
  </div>

  <!-- ëª¨ë‹¬ UI -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full text-center">
      <p id="modal-message" class="text-gray-800 text-lg mb-4"></p>
      <button id="modal-close-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
        í™•ì¸
      </button>
    </div>
  </div>

  <!-- ì¹´ì¹´ì˜¤ SDK -->
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
    // âŒ í™˜ê²½ ë³€ìˆ˜ê°€ ì œê³µë˜ì§€ ì•Šì„ ë•Œë¥¼ ëŒ€ë¹„í•´ Firebase ì„¤ì •ì„ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
    const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
      ? JSON.parse(__firebase_config)
      : {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    let app, db, auth;
    let userId = null;
    let isFirebaseReady = false;

    // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜
    function showModal(message) {
      document.getElementById("modal-message").innerText = message;
      document.getElementById("modal-overlay").classList.remove("hidden");
    }

    document.getElementById("modal-close-btn").addEventListener("click", () => {
      document.getElementById("modal-overlay").classList.add("hidden");
    });

    // Firebase ì´ˆê¸°í™” ë° ì¸ì¦
    async function setupFirebase() {
      try {
        if (Object.keys(firebaseConfig).length > 0) {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }

          userId = auth.currentUser?.uid || crypto.randomUUID();
          console.log("âœ… Firebase ì´ˆê¸°í™” ë° ë¡œê·¸ì¸ ì™„ë£Œ. User ID:", userId);
          isFirebaseReady = true;
          return userId;
        } else {
          console.error("âŒ Firebase ì„¤ì •ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          showModal("Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          return null;
        }
      } catch (error) {
        console.error("âŒ Firebase ì´ˆê¸°í™” ë˜ëŠ” ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜:", error);
        showModal("Firebase ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return null;
      }
    }

    // ì„¤ë¬¸ ê²°ê³¼ Firestore ì €ì¥ í•¨ìˆ˜
    async function saveResultToFirestore(currentUserId) {
      if (!isFirebaseReady) {
        showModal("ì„œë²„ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        return null;
      }

      // ì´ë¯¸ ì €ì¥ëœ ê²½ìš° UUID ë°˜í™˜
      const storedUUID = localStorage.getItem("surveyUUID");
      if (localStorage.getItem("resultSaved") === "true" && storedUUID) {
        console.log("â„¹ï¸ ì„¤ë¬¸ ê²°ê³¼ê°€ ì´ë¯¸ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. UUID:", storedUUID);
        return storedUUID;
      }

      const answers = JSON.parse(localStorage.getItem("surveyAnswers"));
      const scores = JSON.parse(localStorage.getItem("surveyScores"));

      // ë‹µë³€ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
      if (!answers || !scores) {
        showModal("ì„¤ë¬¸ ê²°ê³¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„¤ë¬¸ì— ì°¸ì—¬í•´ ì£¼ì„¸ìš”.");
        return null;
      }

      try {
        // ì„¤ë¬¸ ì§ˆë¬¸ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ ë‹µë³€ ë‚´ìš©ì„ ìƒì„¸í•˜ê²Œ ì €ì¥í•˜ëŠ” ë¡œì§
        const res = await fetch("data/question.json");
        const questionsData = await res.json();

        const allResponses = [];
        const questionMap = {};
        questionsData.common.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "common" });
        questionsData.stage1.forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage1" });
        for (const key in questionsData.stage2) {
          questionsData.stage2[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage2" });
        }
        for (const key in questionsData.stage3) {
          questionsData.stage3[key].forEach(q => questionMap[q.globalIndex] = { ...q, stage: "stage3" });
        }

        for (const key in answers) {
          if (key.startsWith('question-')) {
            const globalIndex = key.split('-')[1];
            const q = questionMap[globalIndex];
            const answerValue = answers[key];

            if (q && answerValue !== undefined) {
              const entry = {
                stage: q.stage,
                question: q.question,
                answer: q.options[answerValue]
              };
              if (q.type) {
                const [left, right] = q.type.split("/");
                entry.type = q.type;
                entry.score = answerValue == "0" ? left : right;
              }
              allResponses.push(entry);
            }
          }
        }

        // ìµœì¢… ìœ í˜• ê³„ì‚°
        function calculateFinalType(scores) {
          let motiType = "";
          const pairs = [
            { axis1: "S", axis2: "I" },
            { axis1: "W", axis2: "T" },
            { axis1: "L", axis2: "R" },
            { axis1: "E", axis2: "Q" }
          ];
          pairs.forEach(pair => {
            if (scores[pair.axis1] > scores[pair.axis2]) {
              motiType += pair.axis1;
            } else if (scores[pair.axis2] > scores[pair.axis1]) {
              motiType += pair.axis2;
            } else {
              motiType += pair.axis1;
            }
          });
          return motiType;
        }

        const finalType = calculateFinalType(scores);

        // ì„¤ë¬¸ ê²°ê³¼ ì €ì¥ ê²½ë¡œ: /artifacts/{appId}/public/data/survey_results
        const docRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/survey_results`), {
          timestamp: serverTimestamp(),
          responses: allResponses, // ìƒì„¸ ë‹µë³€ ë‚´ìš© ì €ì¥
          finalScores: scores,
          finalType: finalType, // ìµœì¢… ìœ í˜• ì €ì¥
          userId: currentUserId, // Firebase ì¸ì¦ UID ì €ì¥
          loginSource: "result",
          connectedAt: null,
        });

        localStorage.setItem("resultSaved", "true");
        localStorage.setItem("surveyUUID", docRef.id);
        console.log("âœ… ì„¤ë¬¸ ê²°ê³¼ ì €ì¥ë¨. UUID:", docRef.id);
        return docRef.id;
      } catch (error) {
        console.error("âŒ Firestore ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
        showModal("ì„¤ë¬¸ ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        return null;
      }
    }

    // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë° ê²°ê³¼ ì—°ê²° í•¨ìˆ˜
    async function connectKakaoAndSaveResult() {
      const surveyUUID = await saveResultToFirestore(userId);
      if (!surveyUUID) return;

      // ğŸ’¡ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì— UUIDë¥¼ ì¶”ê°€í•˜ì—¬ kakao-login-success.htmlì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
      Kakao.Auth.login({
        success: function (authObj) {
          console.log("âœ… ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ:", JSON.stringify(authObj));
          window.location.href = `kakao-login-success.html?uuid=${surveyUUID}`;
        },
        fail: function (err) {
          console.error("âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨:", JSON.stringify(err));
          showModal("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
      });
    }

    window.submitResult = connectKakaoAndSaveResult;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = async function () {
      // Firebase ì´ˆê¸°í™” ë° ì¸ì¦ í›„ userIdë¥¼ ë°›ìŠµë‹ˆë‹¤.
      const authenticatedUserId = await setupFirebase();
      if (authenticatedUserId) {
        // userIdë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¤ë¬¸ ê²°ê³¼ë¥¼ Firestoreì— ì €ì¥í•©ë‹ˆë‹¤.
        await saveResultToFirestore(authenticatedUserId);
      }

      // ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™”
      if (typeof Kakao !== 'undefined' && !Kakao.isInitialized()) {
        // ğŸ’¡ YOUR_KAKAO_API_KEY ëŒ€ì‹  ì‹¤ì œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.
        Kakao.init("cc58d703cacde86ff1976fd723a04854");
        console.log("âœ… ì¹´ì¹´ì˜¤ SDK ì´ˆê¸°í™” ì™„ë£Œ");
      }

      // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      document.getElementById('kakao-btn').addEventListener('click', connectKakaoAndSaveResult);
    };
  </script>
</body>

</html>