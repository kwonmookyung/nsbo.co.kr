<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>ì„¤ë¬¸ ê²°ê³¼</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .result-wrapper {
      max-width: 600px;
      margin: 3em auto;
      padding: 2em;
      background-color: #fdfdfd;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .result-item {
      margin-bottom: 1.5em;
      padding: 1em;
      background: #fafafa;
      border-left: 4px solid #333;
    }

    .checkbox-group a {
      color: black;
      text-decoration: underline;
      transition: color 0.2s ease;
    }

    .checkbox-group a:hover {
      color: blue;
    }

    h2 {
      text-align: center;
      margin-bottom: 1em;
    }

    .back-btn,
    .kakao-btn {
      display: block;
      margin: 2em auto 0;
      padding: 0.8em 2em;
      font-size: 1.1em;
      background-color: black;
      color: white;
      border: none;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
    }

    .checkbox-group {
      margin-top: 2em;
      font-size: 0.95em;
    }

    .checkbox-group label {
      display: block;
      margin-bottom: 0.5em;
    }

    small {
      display: block;
      margin-top: 1em;
      font-size: 0.85em;
      color: #555;
    }
  </style>
</head>
<script>
  function openPopup(url) {
    window.open(url, 'popup', 'width=600,height=700,scrollbars=yes,resizable=yes');
  }
</script>

<body>
  <div class="result-wrapper">
    <h2>ì‚¬ì¥ë‹˜ì˜ MOTI ì„¤ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
    <p>ì‚¬ì¥ë‹˜ì˜ ìœ í˜• ë° ë§ì¶¤ ê²°ê³¼ëŠ” ì¹´ì¹´ì˜¤í†¡ ì±„ë„ì„ í†µí•´ ì „ì†¡ë©ë‹ˆë‹¤.</p>

    <div class="checkbox-group">
      <label>
        <input type="checkbox" id="agreePrivacy" required>
        <a href="#" onclick="openPopup('privacy-policy.html'); return false;">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ë™ì˜ (í•„ìˆ˜)</a>
      </label>
      <small>
        â€» [ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ì•ˆë‚´]<br>
        - ìˆ˜ì§‘ í•­ëª©: ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼, ì„±ë³„, ì—°ë ¹ëŒ€, ì„¤ë¬¸ ì‘ë‹µ<br>
        - ì´ìš© ëª©ì : ì„¤ë¬¸ ê²°ê³¼ ë¶„ì„ ë° ê²°ê³¼ ì „ì†¡, ë§ˆì¼€íŒ… í™œìš©(ì„ íƒ ì‹œ)<br>
        - ë³´ìœ  ê¸°ê°„: ìˆ˜ì§‘ì¼ë¡œë¶€í„° 2ë…„ ë˜ëŠ” ë™ì˜ ì² íšŒ ì‹œê¹Œì§€
      </small>

      <label>
        <input type="checkbox" id="agreeTerms" required>
        <a href="#" onclick="openPopup('terms.html'); return false;">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ë™ì˜ (í•„ìˆ˜)</a>
      </label>

      <label>
        <input type="checkbox" id="agreeChannel" required>
        <a href="#" onclick="openPopup('channel-consent.html'); return false;">ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ì¹œêµ¬ ì¶”ê°€ ë™ì˜ (í•„ìˆ˜)</a>
      </label>

      <label>
        <input type="checkbox" id="agreeMarketing">
        <a href="#" onclick="openPopup('marketing-consent.html'); return false;">ê´‘ê³ ì„± ì •ë³´ ìˆ˜ì‹  ë™ì˜ (ì„ íƒ)</a>
      </label>
      <small>
        â€» ìˆ˜ì‹  ë™ì˜ ì‹œ, ë‹¤ìŒê³¼ ê°™ì€ í˜œíƒì´ ì œê³µë©ë‹ˆë‹¤:<br>
        â€“ ìš°ë¦¬ ë§¤ì¥ì˜ ë§¤ì¶œì„ 2ë°°ë¡œ ë§Œë“œëŠ” <strong>ì£¼ê°„ ë§ì¶¤ ì „ëµ ì†”ë£¨ì…˜</strong><br>
        â€“ ê²½ìŸì‚¬ë³´ë‹¤ ì•ì„œëŠ” <strong>ìµœì‹  ë§ˆì¼€íŒ… íŠ¸ë Œë“œ</strong> ì œê³µ<br>
        ğŸ‘‰ <strong>ì§€ê¸ˆ ë™ì˜í•˜ê³  â€˜ì„±ê³µ ì‚¬ì¥ë‹˜â€™ì˜ ì‹¤ì „ ë…¸í•˜ìš°ë¥¼ í•¨ê»˜ ë°›ì•„ë³´ì„¸ìš”!</strong>
      </small>
    </div>

    <button class="kakao-btn" onclick="submitResult()">ì¹´ì¹´ì˜¤ë¡œ ê²°ê³¼ ë°›ê¸°</button>
    <a href="index.html" class="back-btn">ë‹¤ì‹œ í•˜ê¸°</a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDhL9qWkfXRskWCwYh7E1E901luw1MvIK4",
      authDomain: "nbso-b7f41.firebaseapp.com",
      projectId: "nbso-b7f41",
      storageBucket: "nbso-b7f41.firebasestorage.app",
      messagingSenderId: "94203359555",
      appId: "1:94203359555:web:07f9ee21d1291670363ff6",
      measurementId: "G-YCWF8ENKC4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveResultToFirestore() {
      if (localStorage.getItem("resultSaved") === "true") return null;
      try {
        const answers = JSON.parse(localStorage.getItem("surveyAnswers"));
        const scores = JSON.parse(localStorage.getItem("surveyScores"));
        const res = await fetch("data/question.json");
        const questionsData = await res.json();
        const allResponses = [];

        // âœ… ëª¨ë“  ì§ˆë¬¸ì„ globalIndex ìˆœì„œëŒ€ë¡œ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ë§Œë“­ë‹ˆë‹¤.
        //    survey.htmlì—ì„œ ë¶€ì—¬í•œ globalIndexë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¬ë°”ë¥¸ ìˆœì„œë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
        const allQuestionsFlat = [];
        questionsData.common.forEach(q => allQuestionsFlat[q.globalIndex] = { ...q, stage: "common" });
        questionsData.stage1.forEach(q => allQuestionsFlat[q.globalIndex] = { ...q, stage: "stage1" });
        for (const key in questionsData.stage2) {
          questionsData.stage2[key].forEach(q => allQuestionsFlat[q.globalIndex] = { ...q, stage: "stage2" });
        }
        for (const key in questionsData.stage3) {
          questionsData.stage3[key].forEach(q => allQuestionsFlat[q.globalIndex] = { ...q, stage: "stage3" });
        }

        // âœ… globalIndexë¥¼ ì‚¬ìš©í•˜ì—¬ answersì—ì„œ ë‹µë³€ì„ ì°¾ì•„ allResponsesì— ì¶”ê°€
        for (let i = 0; i < allQuestionsFlat.length; i++) {
          const q = allQuestionsFlat[i];
          if (!q) { // í•´ë‹¹ globalIndexì— ì§ˆë¬¸ì´ ì—†ëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸°
            continue;
          }

          const answerValue = answers[`question-${q.globalIndex}`]; // âœ… ê³ ìœ í•œ globalIndex í‚¤ ì‚¬ìš©

          if (answerValue === undefined) {
             console.warn(`ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: question-${q.globalIndex} - ${q.question}`);
             continue; // ë‹µë³€ì´ ì—†ìœ¼ë©´ ì´ ì§ˆë¬¸ì€ ê±´ë„ˆë›°ê³  ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ
          }

          const entry = {
            stage: q.stage, // âœ… ì—¬ê¸°ì— ìŠ¤í…Œì´ì§€ ì •ë³´ë„ í¬í•¨
            question: q.question,
            answer: q.options[answerValue]
          };
          if (q.type) {
            const [left, right] = q.type.split("/");
            entry.type = q.type;
            entry.score = answerValue == "0" ? left : right; // "0"ì€ ë¬¸ìì—´ ë¹„êµë¡œ ë³€ê²½
          }
          allResponses.push(entry);
        }

        // ìµœì¢… ìœ í˜• ê³„ì‚° ë¡œì§ ì¶”ê°€
        const finalType = calculateFinalType(scores); // âœ… ìµœì¢… ìœ í˜• ê³„ì‚° í•¨ìˆ˜ í˜¸ì¶œ

        const docRef = await addDoc(collection(db, "survey_results"), {
          timestamp: serverTimestamp(),
          expiresAt: new Date(Date.now() + 60 * 60 * 1000), // 1ì‹œê°„ í›„ ë§Œë£Œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
          responses: allResponses,
          finalScores: scores,
          finalType: finalType, // âœ… ìµœì¢… ìœ í˜• ì¶”ê°€
          consents: {
            privacy: document.getElementById("agreePrivacy").checked,
            terms: document.getElementById("agreeTerms").checked,
            kakao_channel: document.getElementById("agreeChannel").checked,
            marketing: document.getElementById("agreeMarketing").checked
          }
        });

        localStorage.setItem("resultSaved", "true");
        localStorage.setItem("surveyUUID", docRef.id);
        // localStorage.setItem("finalMOTIType", finalType); // í•„ìš”í•˜ë‹¤ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ìµœì¢… ìœ í˜• ì €ì¥
        console.log("âœ… ì„¤ë¬¸ ê²°ê³¼ ì €ì¥ë¨. UUID:", docRef.id);
        return docRef.id;
      } catch (error) {
        console.error("âŒ Firestore ì €ì¥ ì¤‘ ì˜¤ë¥˜:", error);
        return null;
      }
    }

    // âœ… ìµœì¢… ìœ í˜• ê³„ì‚° í•¨ìˆ˜
    function calculateFinalType(scores) {
        let motiType = "";
        const pairs = [
            { axis1: "S", axis2: "I" },
            { axis1: "W", axis2: "T" },
            { axis1: "L", axis2: "R" },
            { axis1: "E", axis2: "Q" }
        ];

        pairs.forEach(pair => {
            if (scores[pair.axis1] > scores[pair.axis2]) {
                motiType += pair.axis1;
            } else if (scores[pair.axis2] > scores[pair.axis1]) {
                motiType += pair.axis2;
            } else {
                // ì ìˆ˜ê°€ ê°™ì„ ê²½ìš°, ì–´ë–¤ ì¶•ì„ ì„ íƒí• ì§€ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ë”°ë¼ ê²°ì •
                // ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ ì¶•ì„ ì„ íƒí•˜ë„ë¡ í•¨ (ex: S/Iì—ì„œ S, W/Tì—ì„œ W ë“±)
                // ë˜ëŠ” ë¬´ì‘ìœ„ ì„ íƒ, í˜¹ì€ ì§ˆë¬¸ ìˆœì„œì— ë”°ë¥¸ ê¸°ë³¸ê°’ ë“±ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥.
                // í˜„ì¬ ì„¤ë¬¸ ë¡œì§ì—ì„œëŠ” getClosestPairê°€ ì‚¬ìš©ë˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ì²«ë²ˆì§¸ ì¶•ì„ ë”°ë¦„
                motiType += pair.axis1; 
            }
        });
        return motiType;
    }

    window.submitResult = async function () {
      if (
        !document.getElementById("agreePrivacy").checked ||
        !document.getElementById("agreeTerms").checked ||
        !document.getElementById("agreeChannel").checked
      ) {
        alert("í•„ìˆ˜ í•­ëª©ì— ëª¨ë‘ ë™ì˜í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const uuid = await saveResultToFirestore();
      if (!uuid) return;

      localStorage.setItem("loginSource", "result");
      localStorage.setItem("surveyUUID", uuid);
      window.location.href = "kakao-login.html";
    };
  </script>
</body>

</html>